<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invent√°rio - Leitor QR/Barra</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o do Tailwind para usar a fonte Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'lenovo-blue': '#002D72',
                        'lenovo-light': '#E6E6E6',
                    }
                }
            }  
        }
    </script>
    <style>
        /* Define a fonte Inter (ou fallback) e garante que o corpo ocupe a tela inteira */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Estiliza√ß√£o para garantir que o cont√™iner do leitor n√£o seja muito grande em desktops */
        #reader-container {
            max-width: 450px;
        }
        /* Garantir que o video feed dentro do leitor seja responsivo */
        #reader div {
            width: 100% !important;
        }
    </style>
    
    <!-- Importa√ß√£o da biblioteca html5-qrcode para leitura de c√≥digos -->
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gray-50 flex flex-col items-center p-4 sm:p-8">

    <header class="w-full max-w-4xl mb-6 text-center">
        <h1 class="text-3xl font-extrabold text-lenovo-blue sm:text-4xl">
            Invent√°rio Digital Lenovo
        </h1>
        <p class="text-gray-600 mt-2">Leia c√≥digos de barras ou QR codes para registrar ativos.</p>
    </header>

    <main class="w-full max-w-4xl flex flex-col lg:flex-row gap-8">
        
        <!-- Bloco do Leitor de C√≥digos -->
        <section class="lg:w-1/2 p-5 bg-white shadow-xl rounded-xl border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Leitor de C√≥digo (QR/Barra)</h2>
            <div id="reader-container" class="mx-auto">
                <!-- A √°rea da c√¢mera ser√° injetada aqui -->
                <div id="reader"></div>
            </div>
            <p id="message-display" class="mt-4 p-3 text-center rounded-lg font-medium bg-lenovo-light text-lenovo-blue transition-all duration-300">
                Aguardando permiss√£o da c√¢mera...
            </p>
        </section>

        <!-- Bloco de Invent√°rio e Exporta√ß√£o -->
        <section class="lg:w-1/2 p-5 bg-white shadow-xl rounded-xl border border-gray-200 flex flex-col">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">2. Itens Coletados</h2>

            <div class="flex justify-between items-center mb-4">
                <p class="text-sm font-medium text-gray-500">Total de Itens: <span id="item-count" class="font-bold text-lenovo-blue">0</span></p>
                <button id="export-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 disabled:bg-gray-400" disabled>
                    üìä Exportar CSV
                </button>
            </div>
            
            <div class="overflow-x-auto overflow-y-auto max-h-96 rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200" id="inventory-table">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                C√≥digo (Serial)
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Data/Hora
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Itens do invent√°rio ser√£o inseridos aqui -->
                    </tbody>
                </table>
            </div>

            <button id="clear-btn" class="mt-4 px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                Limpar Invent√°rio Local
            </button>
        </section>
    </main>

    <script>
        // Vari√°veis globais
        const readerId = "reader";
        const tableBody = document.querySelector('#inventory-table tbody');
        const messageDisplay = document.getElementById('message-display');
        const exportBtn = document.getElementById('export-btn');
        const clearBtn = document.getElementById('clear-btn');
        const itemCountSpan = document.getElementById('item-count');
        
        let inventoryData = [];
        const localStorageKey = 'lenovoInventoryData';
        
        // Inicializa o objeto de leitura da biblioteca
        const html5QrCode = new Html5Qrcode(readerId);

        // Configura√ß√µes do leitor
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            // Prioriza o uso da c√¢mera traseira (environment) em dispositivos m√≥veis
            // Se falhar, tentar√° a frontal
        };

        // --- Fun√ß√µes de Estado e UI ---

        /**
         * Carrega o invent√°rio do localStorage.
         */
        function loadInventory() {
            try {
                const storedData = localStorage.getItem(localStorageKey);
                if (storedData) {
                    // JSON.parse √© necess√°rio para converter a string de volta para um array de objetos
                    inventoryData = JSON.parse(storedData);
                } else {
                    inventoryData = [];
                }
            } catch (e) {
                console.error("Erro ao carregar dados do localStorage:", e);
                inventoryData = [];
            }
            renderInventory();
        }

        /**
         * Salva o invent√°rio no localStorage.
         */
        function saveInventory() {
            // JSON.stringify √© necess√°rio para converter o array de objetos para uma string
            localStorage.setItem(localStorageKey, JSON.stringify(inventoryData));
        }

        /**
         * Renderiza a tabela do invent√°rio com base em inventoryData.
         */
        function renderInventory() {
            tableBody.innerHTML = ''; // Limpa a tabela atual
            
            // Renderiza os itens na ordem inversa (o mais recente primeiro)
            inventoryData.slice().reverse().forEach(item => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';

                // C√©lula do C√≥digo
                let codeCell = row.insertCell();
                codeCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
                codeCell.textContent = item.code;

                // C√©lula da Data/Hora
                let timeCell = row.insertCell();
                timeCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                timeCell.textContent = item.timestamp;
            });
            
            // Atualiza o contador e o bot√£o de exportar
            itemCountSpan.textContent = inventoryData.length;
            exportBtn.disabled = inventoryData.length === 0;
        }
        
        // --- Fun√ß√µes de Leitura e Escaneamento ---

        /**
         * Fun√ß√£o de sucesso chamada quando um c√≥digo √© lido.
         */
        const onScanSuccess = (decodedText, decodedResult) => {
            // Verifica se o c√≥digo j√° foi lido recentemente (evita duplica√ß√£o por frames)
            if (inventoryData.length > 0 && inventoryData[inventoryData.length - 1].code === decodedText) {
                return;
            }

            const timestamp = new Date().toLocaleString('pt-BR');

            const newItem = {
                code: decodedText.trim(), // Remove espa√ßos em branco
                timestamp: timestamp
            };
            
            inventoryData.push(newItem);
            saveInventory();
            renderInventory();

            messageDisplay.textContent = `‚úÖ SUCESSO! C√≥digo: ${newItem.code} registrado.`;
            messageDisplay.classList.remove('bg-lenovo-light', 'bg-red-200');
            messageDisplay.classList.add('bg-green-200', 'text-green-800');
            
            // Reverte a cor ap√≥s um breve per√≠odo
            setTimeout(() => {
                 messageDisplay.classList.remove('bg-green-200', 'text-green-800');
                 messageDisplay.classList.add('bg-lenovo-light', 'text-lenovo-blue');
            }, 1500);
        };

        /**
         * Fun√ß√£o de erro (geralmente ignora erros de frame, mas trata falha de inicializa√ß√£o)
         */
        const onScanError = (errorMessage) => {
            // console.warn(`Erro de leitura: ${errorMessage}`); // Comentei para evitar polui√ß√£o do console
        };

        /**
         * Inicia a c√¢mera
         */
        function startScanner() {
            html5QrCode.start(
                { facingMode: "environment" }, // Tenta c√¢mera traseira (environment)
                config,
                onScanSuccess,
                onScanError
            )
            .catch((err) => {
                // Se falhar (ex: sem c√¢mera traseira), tenta c√¢mera frontal (user)
                 html5QrCode.start(
                    { facingMode: "user" },
                    config,
                    onScanSuccess,
                    onScanError
                )
                .then(() => {
                    messageDisplay.textContent = "‚ñ∂Ô∏è Leitor iniciado com c√¢mera frontal. Aponte o c√≥digo.";
                    messageDisplay.classList.remove('bg-lenovo-light');
                })
                .catch((err2) => {
                    messageDisplay.textContent = "‚ùå Falha ao iniciar a c√¢mera. Verifique as permiss√µes do navegador e se o HTTPS/localhost est√° ativo.";
                    messageDisplay.classList.remove('bg-lenovo-light');
                    messageDisplay.classList.add('bg-red-200', 'text-red-800');
                    console.error("Erro ao iniciar a c√¢mera:", err2);
                });
            });
        }
        
        // --- Fun√ß√µes de Exporta√ß√£o e Limpeza ---

        /**
         * Exporta os dados para um arquivo CSV.
         */
        function exportToCsv() {
            if (inventoryData.length === 0) {
                messageDisplay.textContent = "Nenhum item para exportar.";
                return;
            }

            // Define o cabe√ßalho do CSV
            let csvContent = "Serial;Data_Hora_Registro\n";

            // Adiciona cada item, usando ';' como separador para Excel em Portugu√™s
            inventoryData.forEach(item => {
                csvContent += `${item.code};${item.timestamp}\n`;
            });

            // Cria um Blob e dispara o download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `inventario_lenovo_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                messageDisplay.textContent = `üíæ Invent√°rio de ${inventoryData.length} itens exportado!`;
            } else {
                messageDisplay.textContent = "Seu navegador n√£o suporta download autom√°tico de CSV.";
            }
        }

        /**
         * Limpa todos os dados do invent√°rio
         */
        function clearInventory() {
             const isConfirmed = confirm("ATEN√á√ÉO: Voc√™ tem certeza que deseja limpar todo o invent√°rio local? Esta a√ß√£o √© irrevers√≠vel.");
             if (isConfirmed) {
                 inventoryData = [];
                 saveInventory();
                 renderInventory();
                 messageDisplay.textContent = "üóëÔ∏è Invent√°rio local limpo com sucesso.";
                 messageDisplay.classList.add('bg-red-200', 'text-red-800');
                 messageDisplay.classList.remove('bg-lenovo-light', 'text-lenovo-blue');
             }
        }

        // --- Inicializa√ß√£o da Aplica√ß√£o ---
        window.onload = () => {
            loadInventory();
            startScanner();
            
            // Adiciona Listeners
            exportBtn.addEventListener('click', exportToCsv);
            clearBtn.addEventListener('click', clearInventory);
        };

    </script>

</body>
</html>